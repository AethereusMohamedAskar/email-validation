const express = require('express');
const validator = require('deep-email-validator');
const uuid = require('uuid');
const NodeCache = require('node-cache');

const app = express();
app.use(express.json());
global.emailToValidate;
const requestid = uuid.v4();

app.post('/validate', (req, res) => {
  try {
    global.emailToValidate = req.body.emails;
    //const result = await validator.validate(emailToValidate);
    const responsedata={
        requestid : requestid,
        statuscheck:"http://localhost:3000/"+requestid
    }
    //const requestid = uuid.v4();
    res.json(responsedata);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'An error occurred while validating the email address.' });
  }
});
const timeout = 1000;
let timerId = null;

app.get('/:requestid',async (req,res)=>{
  try{
  timerId = setTimeout(() => {
    res.json({status:'pending'});
  }, timeout);
  const results = {};
  for (const email of emailToValidate) {
    
      const result = await validator.validate(email);
      results[email] = result;
    }
  
    
    clearTimeout(timerId);
    res.json({result:results});
}
catch (error) {
  console.error('Email validation failed:', error);
}
    
    
})



app.listen(3000, () => {
  console.log('API listening on port 3000');
});